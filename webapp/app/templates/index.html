<!DOCTYPE html>
<html>
<head>
	
	<title>AMS - Amazon Situation Room</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<!-- <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" /> -->

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <script type="text/javascript" src="{{url_for('static', filename='js/lib/leaflet.wms.js')}}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{{url_for('static', filename='css/leaflet.wmslegend.css')}}"/>
    <script type="text/javascript" src="{{url_for('static', filename='js/lib/leaflet.wmslegend.js')}}"></script>
    <link rel="stylesheet" href="{{url_for('static', filename='css/leaflet.groupedlayercontrol.css')}}"/>
    <script type="text/javascript" src="{{url_for('static', filename='js/lib/leaflet.groupedlayercontrol.js')}}"></script>      
    <script src="https://d3js.org/d3.v6.min.js"></script>

	<style>
		html, body {
			height: 100%;
			margin: 0;
		}
		#map {
			width: 100%;
			height: 100%;
		}
		#spatial-unit-title {
			font-weight: bold;
		}
	</style>

	
</head>
<body>

<div id="map"></div>

<script type="text/javascript">
	function updateMap(source, viewParams, layerStyle) {
		source.options["viewparams"] = viewParams.toWmsFormat();
		if(layerStyle) {
			source.options["sld_body"] = layerStyle.getSLD();
			source._overlay.setParams({
				"viewparams": viewParams.toWmsFormat(),
				"sld_body": layerStyle.getSLD(),
			});				
		}
		else {
			source._overlay.setParams({
				"viewparams": viewParams.toWmsFormat(),
			});	
		}	
	}

	const ViewParams = function(classname, date, limit) {
		this.classname = classname;
		this.date = date;
		this.limit = limit;
		this.toWmsFormat = function() {
			return "classname:"+this.classname+";date:"+this.date+";limit:"+this.limit;
		}
	}

	const SpatialUnits = function(spatialUnits, suDefaultName) {
		this.getSpatialUnit = function getSpatialUnit(name) {
			for(var i = 0; i < this.spatialUnits.length; i++) {
				if(this.spatialUnits[i].dataname == name) {
					return this.spatialUnits[i];
				}
			}
			return null;				
		}			
		this.spatialUnits = spatialUnits;
		this.default = this.getSpatialUnit(suDefaultName);
		this.isSpatialUnit = function(name) {
			for(var i = 0; i < this.spatialUnits.length; i++) {
				if(this.spatialUnits[i].dataname == name) {
					return true;
				}
			}
			return false;			
		}
		this.length = function() {
			return this.spatialUnits.length;
		}
		this.at = function(pos) {
			return this.spatialUnits[pos];
		}	
	}

	const DeterClassGroups = function(groups) {
		this.groups = groups;
		this.length = function() {
			return this.groups.length;
		}
		this.at = function(pos) {
			return this.groups[pos];
		}		
	}

	const PercentageStyle = function(layerName, maxValue, onlyStrokes) {
		this.setStroke = function(onlyStrokes) {
			if(onlyStrokes) {
				this.fillOpacity = 0;
	            this.stroke = `<Stroke><CssParameter name="stroke">#ff0000</CssParameter><CssParameter name="stroke-width">2</CssParameter><CssParameter name="stroke-linejoin">bevel</CssParameter></Stroke>`;			
			}
		}
		this.stroke = "";
		this.fillOpacity = 1;
		this.setStroke(onlyStrokes);
		this.maxValue = maxValue;
		this.createRule = function(v1, v2, color) {
			color = d3.color(color).formatHex();
			let fill = "";
			if(!onlyStrokes) {
				fill = `<Fill><CssParameter name="fill">${color}</CssParameter></Fill>`;
			}
	       return `<Rule><Title> ${v1}% - ${v2}% </Title><ogc:Filter><ogc:PropertyIsGreaterThanOrEqualTo><ogc:PropertyName>percentage</ogc:PropertyName><ogc:Literal>${v1}</ogc:Literal></ogc:PropertyIsGreaterThanOrEqualTo><ogc:PropertyIsLessThan><ogc:PropertyName>percentage</ogc:PropertyName><ogc:Literal>${v2}</ogc:Literal></ogc:PropertyIsLessThan></ogc:Filter><PolygonSymbolizer>${fill}${this.stroke}</PolygonSymbolizer></Rule>`;				
		} 
		this.getMaxLength = function(values) {
  			let vMaxLength = 0;
  			let vMax = 0;
  			for(let i = 0; i < values.length - 1; i++) {
  				let v2 = values[i+1];
  				let vlength = v2.toString().length;
  				if(vlength > vMaxLength) {
  					vMaxLength = vlength;
  					vMax = v2.toString();
  				}
  			}
  			if(vMax.includes(".")) {
  				vMaxLength = vMax.split(".")[1].length;
  			}
  			return vMaxLength;
		}
		this.createRules = function(numOfRanges) {
			let legend = d3.scaleLinear()
				.domain([0, this.maxValue])
  				.range(["#f0f0f0", "#ff0000"])
  				.nice(numOfRanges);
  			let ticks = legend.ticks(numOfRanges);
  			let rules = "";
  			let vMaxLength = this.getMaxLength(ticks);
  			for(let i = 0; i < ticks.length - 1; i++) {
  				let v1 = ticks[i];
  				let v2 = ticks[i+1];
  				let color = legend(v1);
				rules = `${rules}${this.createRule(v1.toFixed(vMaxLength), v2.toFixed(vMaxLength), color)}`;
  			} 			
  			
  			return rules;						
		}
		this.sld = `<?xml version="1.0" encoding="ISO-8859-1"?>	<StyledLayerDescriptor version="1.0.0" xsi:schemaLocation="http://www.opengis.net/sld StyledLayerDescriptor.xsd" xmlns="http://www.opengis.net/sld" xmlns:ogc="http://www.opengis.net/ogc" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><NamedLayer><Name>${layerName}</Name><UserStyle><Title>SLD Cook Book: Attribute-based polygon</Title><FeatureTypeStyle>${this.createRules(6)}</FeatureTypeStyle></UserStyle></NamedLayer></StyledLayerDescriptor>`;	
		this.getSLD = function() {
			return this.sld;
		}
		this.getEncodeURI = function() {
			return encodeURIComponent(this.sld);
		}
	}	

	const WFS = function(url) {
		this.url = url;
		this.getMax = function(layerName, propertyName, classname, date) {
			let wfsUrl = this.url 
						+ "&typeName=" + layerName
						+ "&propertyName=" + propertyName
						+ "&outputFormat=json"
						+ "&viewparams=classname:"+classname+";date:"+date+";limit:1";
			var res;
			$.ajax({
				dataType: "json",
				url: wfsUrl,
				async: false, 
				success: function(data) {
					res = data["features"][0]["properties"][propertyName];
				}
			});		
			return res;			
		}	
	}

	var gsWorkspace = "{{workspace}}"; 
	var sus = {{spatial_units_info|safe}};
	var spatialUnits = new SpatialUnits(sus, sus[0].dataname);
	var deterClassGroups = new DeterClassGroups({{deter_class_groups|safe}});

	var wfsUrl = "http://localhost:8080/geoserver/ows?SERVICE=WFS&REQUEST=GetFeature"
	var wfs = new WFS(wfsUrl);

	var map = new L.Map("map").setView([spatialUnits.default.center_lat, spatialUnits.default.center_lng], 5);

	var osmLayer = new L.TileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
		attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
		maxZoom: 18,
		crs: L.CRS.EPSG4326
	}).addTo(map);

	var suViewParams = new ViewParams(deterClassGroups.at(0).name, "2020-10-01", "ALL");
	var suLayerName = gsWorkspace + ":" + spatialUnits.default.dataname + "_view";
	var suLayerMaxPercentage = wfs.getMax(suLayerName, "percentage", suViewParams.classname, suViewParams.date) 
	var suLayerStyle = new PercentageStyle(suLayerName, suLayerMaxPercentage);
	var wmsUrl = "http://localhost:8080/geoserver/wms?"
	var wmsOptions = {
		"transparent": true, 
		"tiled": true, 
		"format": "image/png", 
		// "identify": false
		"opacity": 0.6,
		// "noRedraw": false,
		// "styles": "ams:ams_percentage",
		// "env": "v0:0;v1:0.008;v2:0.009;v3:0.1;v4:0.02;v5:1",
		"viewparams": suViewParams.toWmsFormat(),
		"sld_body": suLayerStyle.getSLD(),
	};
	var suSource = L.WMS.source(wmsUrl, wmsOptions);
	var suLayer = suSource.getLayer(suLayerName);
	var currentLayer = suLayer;
	suLayer.addTo(map);	

	var priorLayerName = suLayerName;
	var priorLayerStyle = new PercentageStyle(suLayerName, suLayerMaxPercentage, true);
	var priorViewParams = new ViewParams(deterClassGroups.at(0).name, "2020-07-01", "15");	
	var priorWmsOptions = {
		"transparent": true, 
		"tiled": true, 
		"format": "image/png", 
		// "identify": false
		// "opacity": 0.6,
		// "noRedraw": false,
		// "styles": "ams:ams_percentage",
		// "env": "v0:0;v1:0.008;v2:0.009;v3:0.1;v4:0.02;v5:1",
		"viewparams": priorViewParams.toWmsFormat(),
		"sld_body": priorLayerStyle.getSLD(),

	};
	var priorSource = L.WMS.source(wmsUrl, priorWmsOptions);
	var priorLayer = priorSource.getLayer(suLayerName);
	priorLayer.addTo(map);

	var suLayers = {};
	suLayers[spatialUnits.default.dataname] = suLayer;

	var groupedOverlays = {
		"Spatial Unit": {
			[spatialUnits.default.dataname]: suLayer
		},
		"Indicator": {},
		"Class": {},
	};	
	
	for(var i = 1; i < spatialUnits.length(); i++) {
		var layer = suSource.getLayer(gsWorkspace + ":" + spatialUnits.at(i).dataname);
		suLayers[spatialUnits.at(i).dataname] = layer;
		groupedOverlays["Spatial Unit"][spatialUnits.at(i).dataname] = layer;
	}

	var indicatorLayer = new L.WMS.Layer(wmsUrl, "percentage", wmsOptions).addTo(map);	
	groupedOverlays["Indicator"]["Area"] = indicatorLayer;
	
	var classLayer = new L.WMS.Layer(wmsUrl, deterClassGroups.at(0).name, wmsOptions).addTo(map);	
	groupedOverlays["Class"][deterClassGroups.at(0).name] = classLayer;	
	
	for(var i = 1; i < deterClassGroups.length(); i++)
	{
		let layer = new L.WMS.Layer(wmsUrl, deterClassGroups.at(i).name, wmsOptions);	
		groupedOverlays["Class"][deterClassGroups.at(i).name] = layer;
	}

	var groupControl = L.control.groupedLayers(null, groupedOverlays, {
		exclusiveGroups: ["Spatial Unit", "Indicator", "Class"],
		collapsed: false,
	});
	
	groupControl.addTo(map);

	var legendUrl = wmsUrl 
					+ "REQUEST=GetLegendGraphic&FORMAT=image/png&WIDTH=20&HEIGHT=20"
					+ "&LAYER=" + suLayerName
					+ "&sld_body=" + suLayerStyle.getEncodeURI(); 
	var wmsLegendControl = new L.Control.WMSLegend;
    wmsLegendControl.options.uri = legendUrl;
    wmsLegendControl.options.position = "bottomright";
    map.addControl(wmsLegendControl);	

	map.on('overlayadd', function(e) {
		if(!spatialUnits.isSpatialUnit(e.name)) {
			suViewParams.classname = e.name;
			priorViewParams.classname = e.name;
			var maxPercentage = wfs.getMax(suLayerName, "percentage", suViewParams.classname, suViewParams.date);
			suLayerStyle = new PercentageStyle(suLayerName, maxPercentage);
			
			var priorLayerStyle = new PercentageStyle(suLayerName, maxPercentage, true);
			legendUrl = wmsUrl 
						+ "REQUEST=GetLegendGraphic&FORMAT=image/png&WIDTH=20&HEIGHT=20"
						+ "&LAYER=" + suLayerName
						+ "&sld_body=" + suLayerStyle.getEncodeURI();
		    wmsLegendControl.options.uri = legendUrl;
		    wmsLegendControl.options.position = "bottomright";
		    map.removeControl(wmsLegendControl);
		    map.addControl(wmsLegendControl);	

			updateMap(priorSource, priorViewParams, priorLayerStyle);
			updateMap(suSource, suViewParams, suLayerStyle);					
		}
		else {
			console.log(e);
			suSource.options["styles"] = '';
			suSource.options["viewparams"] = '';
			suSource.options["env"] = '';
			suSource._overlay.setParams({
				"styles": '',
				"viewparams": '',
				"env": '',
			});					
		}
	});	

	$('<div class="leaflet-control-layers-group" id="prioritization-control-layers-group-name"><label class="leaflet-control-layers-group-name"><span class="leaflet-control-layers-group-name">Prioritization </span><input type="number" id="prioritization-input" min="1" max="50" value=' 
		+ priorViewParams.limit + ' /></label></div>').insertAfter('#leaflet-control-layers-group-2');	

	$("#prioritization-input").keypress(function(e) {
		if (e.which == 13) {
			let limit = document.getElementById("prioritization-input").value;
			priorViewParams.limit = limit;
			updateMap(priorSource, priorViewParams);	
			return false;
		}
	});
 
</script>
</body>
</html>
