/*!
 * leaflet.wms.js
 * A collection of Leaflet utilities for working with Web Mapping services.
 * (c) 2014-2016, Houston Engineering, Inc.
 * MIT License
 */(function(a){if(typeof define=='function'&&define.amd)define(['leaflet'],a);else if(typeof module!='undefined')module.exports=a(require('leaflet'));else{if(typeof this.L=='undefined')throw'Leaflet must be loaded first!';this.L.WMS=this.L.wms=a(this.L)}})(function(b){var a={},c;'keys'in Object||(Object.keys=function(a){var b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(c);return b});async function d(e,f,a,b){let c={};a&&a.forEach(a=>{c[a.header]=a.value});const d=new AbortController,g=d.signal;b&&b.subscribe(()=>{d.abort()});const h=await fetch(e,{method:"GET",headers:c,mode:"cors",signal:g,credentials:'omit',cache:'no-cache'}),i=await h.blob();f(i)}a.Source=b.Layer.extend({options:{untiled:!0,identify:!0},initialize:function(a,c){b.setOptions(this,c),this.options.tiled&&(this.options.untiled=!1),this._url=a,this._subLayers={},this._overlay=this.createOverlay(this.options.untiled)},createOverlay:function(d){var c={},b;for(b in this.options)b!='untiled'&&b!='identify'&&(c[b]=this.options[b]);return d?a.overlay(this._url,c):a.wmsHeader(this._url,c)},onAdd:function(){this.refreshOverlay()},getEvents:function(){return this.options.identify?{click:this.identify}:{}},setOpacity:function(a){this.options.opacity=a,this._overlay&&this._overlay.setOpacity(a)},bringToBack:function(){this.options.isBack=!0,this._overlay&&this._overlay.bringToBack()},bringToFront:function(){this.options.isBack=!1,this._overlay&&this._overlay.bringToFront()},getLayer:function(b){return a.layer(this,b)},addSubLayer:function(a){this._subLayers[a]=!0,this.refreshOverlay()},removeSubLayer:function(a){delete this._subLayers[a],this.refreshOverlay()},refreshOverlay:function(){var a=Object.keys(this._subLayers).join(",");if(!this._map)return;a?(this._overlay.setParams({layers:a}),this._overlay.addTo(this._map)):this._overlay.remove()},identify:function(a){var b=this.getIdentifyLayers();if(!b.length)return;this.getFeatureInfo(a.containerPoint,a.latlng,b,this.showFeatureInfo)},getFeatureInfo:function(d,e,f,g){let a=this.getFeatureInfoParams(d,f);a.info_format='application/json';let c=this._url+b.Util.getParamString(a,this._url);this.showWaiting(),this.ajax(c,h);function h(a){this.hideWaiting();var b=this.parseFeatureInfo(a,c);g.call(this,e,b)}},ajax:function(a,b){e.call(this,a,b)},getIdentifyLayers:function(){return this.options.identifyLayers?this.options.identifyLayers:Object.keys(this._subLayers)},getFeatureInfoParams:function(d,e){var a,c,f;return this.options.untiled?a=this._overlay.wmsParams:(c=this.createOverlay(!0),c.updateWmsParams(this._map),a=c.wmsParams,a.layers=e.join(',')),f={request:'GetFeatureInfo',query_layers:e.join(','),X:Math.round(d.x),Y:Math.round(d.y)},b.extend({},a,f)},parseFeatureInfo:function(a,b){return a=="error"&&(a="<iframe src='"+b+"' style='border:none'>"),a},showFeatureInfo:function(a,b){if(!this._map)return;this._map.openPopup(b,a)},showWaiting:function(){if(!this._map)return;this._map._container.style.cursor="progress"},hideWaiting:function(){if(!this._map)return;this._map._container.style.cursor="default"}}),a.source=function(b,c){return new a.Source(b,c)},a.Layer=b.Layer.extend({initialize:function(c,e,d){b.setOptions(this,d),c.addSubLayer||(c=a.getSourceForUrl(c,d)),this._source=c,this._name=e},onAdd:function(){this._source._map||this._source.addTo(this._map),this._source.addSubLayer(this._name)},onRemove:function(){this._source.removeSubLayer(this._name)},setOpacity:function(a){this._source.setOpacity(a)},bringToBack:function(){this._source.bringToBack()},bringToFront:function(){this._source.bringToFront()}}),a.layer=function(b,c){return new a.Layer(b,c)},c={},a.getSourceForUrl=function(b,d){return c[b]||(c[b]=a.source(b,d)),c[b]},a.TileLayer=b.TileLayer.WMS,a.tileLayer=b.tileLayer.wms,a.Overlay=b.Layer.extend({defaultWmsParams:{service:'WMS',request:'GetMap',version:'1.1.1',layers:'',styles:'',format:'image/jpeg',transparent:!1},options:{crs:null,uppercase:!1,attribution:'',opacity:1,isBack:!1,minZoom:0,maxZoom:18},initialize:function(f,c){var d,e,a;this._url=f,d={},e={};for(a in c)a in this.options?e[a]=c[a]:d[a]=c[a];b.setOptions(this,e),this.wmsParams=b.extend({},this.defaultWmsParams,d)},setParams:function(a){b.extend(this.wmsParams,a),this.update()},getAttribution:function(){return this.options.attribution},onAdd:function(){this.update()},onRemove:function(a){this._currentOverlay&&(a.removeLayer(this._currentOverlay),delete this._currentOverlay),this._currentUrl&&delete this._currentUrl},getEvents:function(){return{moveend:this.update}},update:function(){var c,d,a;if(!this._map)return;if(this.updateWmsParams(),c=this.getImageUrl(),this._currentUrl==c)return;this._currentUrl=c,d=this._map.getBounds(),a=b.imageOverlay(c,d,{opacity:0}),a.addTo(this._map),a.once('load',e,this);function e(){if(!this._map)return;if(a._url!=this._currentUrl){this._map.removeLayer(a);return}this._currentOverlay&&this._map.removeLayer(this._currentOverlay),this._currentOverlay=a,a.setOpacity(this.options.opacity?this.options.opacity:1),this.options.isBack===!0&&a.bringToBack(),this.options.isBack===!1&&a.bringToFront()}(this._map.getZoom()<this.options.minZoom||this._map.getZoom()>this.options.maxZoom)&&this._map.removeLayer(a)},setOpacity:function(a){this.options.opacity=a,this._currentOverlay&&this._currentOverlay.setOpacity(a)},bringToBack:function(){this.options.isBack=!0,this._currentOverlay&&this._currentOverlay.bringToBack()},bringToFront:function(){this.options.isBack=!1,this._currentOverlay&&this._currentOverlay.bringToFront()},updateWmsParams:function(a){var h,i,g,d,j,e,c,f;a||(a=this._map),h=a.getBounds(),i=a.getSize(),g=parseFloat(this.wmsParams.version),d=this.options.crs||a.options.crs,j=g>=1.3?'crs':'srs',e=d.project(h.getNorthWest()),c=d.project(h.getSouthEast()),f={width:i.x,height:i.y},f[j]=d.code,f.bbox=(g>=1.3&&d===b.CRS.EPSG4326?[c.y,e.x,e.y,c.x]:[e.x,c.y,c.x,e.y]).join(','),b.extend(this.wmsParams,f)},getImageUrl:function(){var a=this.options.uppercase||!1,c=b.Util.getParamString(this.wmsParams,this._url,a);return this._url+c}}),a.overlay=function(b,c){return new a.Overlay(b,c)};function e(b,d){var e=this,a=new XMLHttpRequest;a.onreadystatechange=f;let c=null;if(ams.Auth.isAuthenticated()){let a=document.location.protocol+'//'+document.location.hostname+ams.Config.general.oauthAPIProxyURI;c="Bearer "+AuthenticationService.getToken(),b=a+b}a.open('GET',b),a.withCredentials=!1,c&&a.setRequestHeader("Authorization",c),a.send();function f(){a.readyState===4&&(a.status===200?d.call(e,a.responseText):d.call(e,"error"))}}return a.WMSHeader=b.TileLayer.WMS.extend({initialize:function(a,c){b.TileLayer.WMS.prototype.initialize.call(this,a,c),this._initURL=a,this.updateURL()},updateURL:function(){ams.Auth.isAuthenticated()?(this._url=document.location.protocol+'//'+document.location.hostname,this._url+=ams.Config.general.oauthAPIProxyURI,this._url+=this._initURL,this._headers=[{header:"Authorization",value:"Bearer "+AuthenticationService.getToken()}]):(this._url=this._initURL,this._headers=[])},createTile:function(b,c){this.updateURL();const e=this.getTileUrl(b),a=document.createElement("img");return a.setAttribute("role","presentation"),self=this,d(e,d=>{const b=new FileReader;b.onload=()=>{a.src=b.result,self.results&&self.results.next(b.result)},b.readAsDataURL(d),c(null,a)},this._headers,null),a}}),a.wmsHeader=function(b,c,d,e,f){return new a.WMSHeader(b,c,d,e,f)},a})