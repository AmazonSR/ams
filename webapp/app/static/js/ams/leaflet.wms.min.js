var ams=ams||{};ams.LeafletWms={Source:L.WMS.Source.extend({initialize:function(a,b,c){L.setOptions(this,b),this.options.tiled&&(this.options.untiled=!1),this._url=a,this._subLayers={},this._overlay=this.createOverlay(this.options.untiled),this._deterClassGroups=c},showFeatureInfo:function(f,e){if(e.includes("no features were found")){$('.toast').toast('show'),$('.toast-body').html("Sem informações para este local.");return}let d=JSON.parse(e),a="",b="",c="";if(d.numberReturned>=1)if(this._isDeterInfo()?(b="DETER",c="deter",a=this._formatDeterPopup(d)):this._isAFInfo()?(b="Queimadas",c="af",a=this._formatAFPopup(d)):this._isRKInfo()?(b="Risco de Desmatamento",c="risk",a=this._formatRiskPopup(d)):(b="Unidade Espacial",c="su",a=this._formatSpatialUnitPopup(d)),c!=""&&b!=""&&a!=""){ams.Map.PopupControl._infoBody.push({type:c,name:b,htmlInfo:a});let d=this._accordionFormat();ams.Map.PopupControl._popupReference&&ams.Map.PopupControl._popupReference._popup?ams.Map.PopupControl._popupReference._popup.setContent(d):(ams.Map.PopupControl._popupReference=this._map.openPopup(d,f),ams.Map.PopupControl._popupReference.on('popupclose',()=>{ams.Map.PopupControl._infoBody=[]}))}},_accordionFormat:function(){let a='<div id="accordion">';for(let c in ams.Map.PopupControl._infoBody){let b=ams.Map.PopupControl._infoBody[c];a=a+'<div class="card">'+'    <div class="card-header">'+'    <a class="'+(b.type=='su'?'':'collapsed ')+'card-link" data-toggle="collapse" href="#collapse'+c+'">'+'        '+b.name+'    </a>'+'    </div>'+'    <div id="collapse'+c+'" class="collapse'+(b.type=='su'?' show':'')+'" data-parent="#accordion">'+'    <div class="card-body">'+'        '+b.htmlInfo+'    </div>'+'    </div>'+'</div>'}return a=a+'</div>',a},_isDeterInfo:function(){return this._overlay.wmsParams.layers.includes(ams.Config.defaultLayers.deter)},_isAFInfo:function(){return this._overlay.wmsParams.layers.includes(ams.Config.defaultLayers.activeFire)},_isRKInfo:function(){return this._overlay.wmsParams.layers.includes(ams.Config.defaultLayers.ibamaRisk)},_updateResults:function(b,c){let a=c.features[0].properties;for(let c in a){let d=a[c]==null||a[c]==""?"-":a[c];c in b&&(c=="area"&&ams.Map.PopupControl._unit=='ha'&&(d=d*100,b.area_unit=ams.Map.PopupControl._unit),b[c]=isNaN(d)?d:ams.Utils.numberFormat(d))}},_formatSpatialUnitPopup:function(c){let a={name:"",classname:"",area:0,counts:0,percentage:0,area_unit:"km²"};this._updateResults(a,c);let b="";return a.area!=0&&(b=this._createGraphicButton(a.name),["DS","DG","CS","MN"].includes(a.classname)&&(b+=this._createSaveButton(a.name))),this._createSpatialUnitInfoTable(a)+b},_formatClassName:function(a){return a!="null"?this._deterClassGroups.getGroupName(a):" "},_getViewConfig:function(b){let c=b.replace(/ /g,"|"),a={};return a.className=ams.App._suViewParams.classname,a.spatialUnit=ams.App._currentSULayerName.split(":")[1],a.startDate=ams.App._dateControl.startdate,a.tempUnit=ams.App._currentTemporalAggregate,a.tempUnit==="custom"&&(a.tempUnit=ams.App._dateControl.customDays+"d",a.custom=!0),a.suName=c,a.landUse=ams.App._landUseList.join(','),a},_createGraphicButton:function(a){let b=this._getViewConfig(a),c='<div style="display:inline-flex;justify-content:space-between;"><button class="btn btn-primary-p btn-success" style="margin:1px" onclick=ams.App.displayGraph('+JSON.stringify(b)+')>Perfil</button>'+'</div>';return c},_createSaveButton:function(a){let b=this._getViewConfig(a),c='<div style="display:inline-flex;justify-content:space-between;"><button class="btn btn-primary-p btn-success" style="margin:1px" onclick=ams.App.saveAlerts('+JSON.stringify(b)+')>Salvar alertas</button>'+'</div>';return c},_createSpatialUnitInfoTable:function(a){let b=focus=deter="";return a.classname=="AF"?focus="<tr><td>Focos (unidades)   </td><td>"+a.counts+"</td>"+"</tr>":a.classname=="RK"?b="<tr><td>Riscos (unidades)   </td><td>"+a.counts+"</td>"+"</tr>":deter="<tr><td>&#193;rea ("+a.area_unit+")</td>"+"<td>"+a.area+"</td>"+"</tr>"+"<tr>"+"<td>Porcentagem   </td>"+"<td>"+a.percentage+"%</td>"+"</tr>",'<table class="popup-spatial-unit-table"><tr><th>Nome</th><th>Valor</th></tr><tr><td>Unidade Espacial   </td><td style=\'text-align-last: center;\'>'+a.name+"</td>"+"</tr>"+"<tr>"+"<td>Classe   </td>"+"<td>"+this._formatClassName(a.classname)+"</td>"+"</tr>"+b+focus+deter+"</table>"},_formatRiskPopup:function(b){let a={id:0,risk:0,expiration_date:"",risk_date:""};return this._updateResults(a,b),this._createRiskInfoTable(a)},_createRiskInfoTable:function(b){let a='<table class="popup-deter-table" style="width:100%"><tr><th></th><th></th></tr>';for(let d in b){let c=b[d];d.includes("date")&&(c=this._formatDate(c)),a+="<tr><td>"+d+"  </td>"+"<td>"+(c!="null"?c:" ")+"</td>"+"</tr>"}return a+="</table>",a},_formatAFPopup:function(b){let a={diasemchuva:0,estado:"",municipio:"",precipitacao:0,riscofogo:0,satelite:"",view_date:""};return this._updateResults(a,b),this._createAFInfoTable(a)},_createAFInfoTable:function(b){let a='<table class="popup-deter-table" style="width:100%"><tr><th></th><th></th></tr>';for(let d in b){let c=b[d];d.includes("view_date")&&(c=this._formatDate(c)),a+="<tr><td>"+d+"  </td>"+"<td>"+(c!="null"?c:" ")+"</td>"+"</tr>"}return a+="<tr><td colspan='2'><a target='_blank' href='"+ams.Config.AFMetadataURL+"'>Ver detalhes dos atributos</a></td></tr>",a+="</table>",a},_formatDeterPopup:function(b){let a={classname:"",view_date:"",areamunkm:0,areatotalkm:0,areauckm:0,municipality:"",ncar_ids:null,uc:null,uf:"",car_imovel:null,continuo:"",deltad:0,dominio:"",est_fund:"",ncar_ids:null,tp_dominio:"",velocidade:0};return this._updateResults(a,b),this._createDeterInfoTable(a)},_createDeterInfoTable:function(b){let a='<table class="popup-deter-table" style="width:100%"><tr><th></th><th></th></tr>';for(let d in b){let c=b[d];d.includes("view_date")&&(c=this._formatDate(c)),d.includes("car_imovel")&&c.split(";").length>=1?a+="<tr><td colspan='2'>"+d+(c!="null"?this._formatListCAR(c):" ")+"</td>"+"</tr>":a+="<tr><td>"+d+"  </td>"+"<td>"+(c!="null"?c:" ")+"</td>"+"</tr>"}return a+="<tr><td colspan='2'><a target='_blank' href='"+ams.Config.DETERMetadataURL+"'>Ver detalhes dos atributos</a></td></tr>",a+="</table>",a},_formatDate:function(b){let a=b.replace("Z","").split("-");return`${a[2]}/${a[1]}/${a[0]}`},_formatListCAR:function(a){let b=a.replaceAll(";","\n");return"<div id='ids_car'><textarea name='listcars' rows='2' cols='40' readonly style='resize: none;max-width: fit-content;border:0;font-size:xx-small;'>"+b+"</textarea></div>"}})}