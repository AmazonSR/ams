var ams=ams||{};ams.Map={PopupControl:{_popupReference:null,_unit:'km²',_text:'área (km²)',_prefix:'Valor do indicador: ',_infoBody:[]},ViewParams:function(c,a,d,e,b){this.classname=c,this.startdate=a.startdate,this.enddate=a.enddate,this.prevdate=a.prevdate,this.propertyName=d,this.limit=e,this.risk_threshold=typeof b=='undefined'?0:b,this.toWmsFormat=function(){return"classname:"+this.classname+";startdate:"+this.startdate+";enddate:"+this.enddate+";prevdate:"+this.prevdate+";orderby:"+this.propertyName+";landuse:"+ams.App._landUseList.join('\\,')+";limit:"+this.limit+";risk:"+this.risk_threshold},this.updateDates=function(a){this.startdate=a.startdate,this.enddate=a.enddate,this.prevdate=a.prevdate},this.updatePropertyName=function(a){this.propertyName=a},this.updateRiskThreshold=function(a){this.risk_threshold=this.classname=='RK'?a:0}},SpatialUnits:function(a,b){this.spatialUnits=a,this.defaultName=b,this.default=null,this.getDefault=function(){return this.default||(this.default=this.find(this.defaultName)),this.default},this.find=function(a){return this.spatialUnits.find(b=>b.dataname==a)},this.length=function(){return this.spatialUnits.length},this.at=function(a){return this.spatialUnits[a]}},AppClassGroups:function(a){this._groupNamesMap={},this._setNames=function(a){let c=null;for(var b=0;b<a.length;b++)a[b].name=='RK'&&!ams.Auth.isAuthenticated()&&(c=b),a[b].acronym=a[b].name,this._groupNamesMap[a[b].name]=a[b].title,a[b].name=a[b].title;c!==null&&a.splice(c,1),this.groups=a},this._setNames(a),this.length=function(){return this.groups.length},this.at=function(a){return this.groups[a]},this.getGroup=function(a){for(let b=0;b<this.groups.length;b++)if(this.groups[b].acronym==a)return this.groups[b]},this._filterClasses=function(d){let b=this.getGroup(d),a="",c=b.classes;for(let d=0;d<c.length;d++)a+="classname='"+c[d]+"'",d<b.classes.length-1&&(a+=" OR ");return a},this.getCqlFilter=function(b,a){a=typeof a=='undefined'?!0:a;let c=a?"AND ("+this._filterClasses(b.classname)+")":"";return"(view_date > "+b.enddate+") AND (view_date <= "+b.startdate+") "+c},this.getGroupName=function(a){return this._groupNamesMap[a]}},WFS:function(a){this.baseUrl=a,this.url=this.baseUrl+"/ows?SERVICE=WFS&REQUEST=GetFeature",this.getURL=function(){let a=this.url;if(ams.Auth.isAuthenticated()){let b=document.location.protocol+'//'+document.location.hostname;a=b+ams.Config.general.oauthAPIProxyURI+this.url}return a},this.getMinOrMax=function(d,b,a,e){let f=this.getURL()+"&typeName="+d+"&propertyName="+b+"&outputFormat=json"+"&viewparams=classname:"+a.classname+";startdate:"+a.startdate+";enddate:"+a.enddate+";prevdate:"+a.prevdate+";order:"+(e?'ASC':'DESC')+";orderby:"+b+";landuse:"+ams.App._landUseList.join('%5C,')+";risk:"+a.risk_threshold+";limit:1",c;return $.ajax({dataType:"json",url:f,async:!1,headers:{Authorization:'Bearer '+(ams.Auth.isAuthenticated()?Authentication.getToken():"")},success:function(a){c=a.totalFeatures>0?a.features[0].properties[b]:!1},error:function(){c=!1}}),c},this.getMax=function(a,b,c){return this.getMinOrMax(a,b,c,!1)},this.getMin=function(a,b,c){return this.getMinOrMax(a,b,c,!0)},this.getLastDate=function(c){let b="last_date",d=ams.App._suViewParams?ams.App._suViewParams.classname:ams.Config.defaultFilters.indicator,e=this.getURL()+"&typeName="+c+"&propertyName="+b+"&outputFormat=json"+"&viewparams=classname:"+d+";landuse:"+ams.App._landUseList.join('%5C,'),a;return $.ajax({dataType:"json",url:e,async:!1,headers:{Authorization:'Bearer '+(ams.Auth.isAuthenticated()?Authentication.getToken():"")},success:function(c){a=c.features[0].properties[b]},error:function(){a=!1}}),a},this.getFile=function(g,a,o,f,h,n){let d=g.substring(g.indexOf(':')+1).replace("_view",""),m=ams.PeriodHandler._startdate.toLocaleDateString().replaceAll('/','-'),p=ams.PeriodHandler._enddate.toLocaleDateString().replaceAll('/','-'),l=ams.PeriodHandler._previousdate.toLocaleDateString().replaceAll('/','-'),i='';const j="_diff";d.indexOf(j)>0&&(i="_"+l,d=d.replace(j,""));let c=ams.App._spatialUnits.find(d);c=c?c.description:d,c=c.replaceAll(" ","_");let b=ams.App._appClassGroups.getGroupName(a.classname);b=b||a.classname,b=b.replaceAll(" ","_");let e=ams.Config.biome+"_"+c+"_"+b+"_"+p+"_"+m+i+"."+f,k=this.getURL()+"&typeName="+g+"&outputFormat="+o+"&format_options=filename:"+e+"&version=1.0.0"+"&propertyName="+(h||"")+"&viewparams=classname:"+a.classname+";startdate:"+a.startdate+";enddate:"+a.enddate+";prevdate:"+a.prevdate+";orderby:"+n+";landuse:"+ams.App._landUseList.join('%5C,')+";risk:"+a.risk_threshold+";limit:ALL"+(f=='csv'?"":";optype:DOWNLOAD");if(f=='csv')$.ajax({url:k,async:!1,headers:{Authorization:'Bearer '+(ams.Auth.isAuthenticated()?Authentication.getToken():"")},success:function(b){const c=new Blob([b],{type:"application/octet-stream"}),d=window.URL.createObjectURL(c),a=document.createElement("a");a.href=d,a.download=e,a.click()},error:function(b,a){window.console.log(a)}});else{let a=document.createElement("a");a.href=k,a.setAttribute("download",e),a.click()}},this.getShapeZip=function(a,b){let c="name,"+(ams.App._propertyName=="area"?"area,percentage":ams.App._propertyName)+",geometry";this.getFile(a,b,"shape-zip","zip",c,ams.App._propertyName)},this.getCsv=function(a,b){let c="name,"+(ams.App._propertyName=="area"?"area,percentage":ams.App._propertyName);this.getFile(a,b,"csv","csv",c,ams.App._propertyName)}},TemporalUnits:function(){this.aggregates={0:{key:"7d",value:"Agregado 7 dias"},1:{key:"15d",value:"Agregado 15 dias"},2:{key:"1m",value:"Agregado 30 dias"},3:{key:"3m",value:"Agregado 90 dias"},4:{key:"1y",value:"Agregado 365 dias"},5:{key:"custom",value:"Agregado customizado"}},this.differeces={0:{key:"onPeriod",value:"No Per&#237;odo"},1:{key:"periodDiff",value:"Diferen&#231;a Per&#237;odo Anterior"}},this.getCurrentName=function(){return this.differeces[0].value},this.getAggregates=function(){return this.aggregates},this.getDifferences=function(){return this.differeces},this.isAggregate=function(a){for(let b=0;b<Object.keys(this.aggregates).length;b++)if(this.aggregates[b].value==a)return!0;return!1},this.isDifference=function(a){for(let b=0;b<Object.keys(this.differeces).length;b++)if(this.differeces[b].value==a)return!0;return!1}},LegendController:function(a,b){this._wmsLegendControl=new L.Control.WMSLegend,this._url,this.baseURL=b,this._map=a,this.setUrl=function(a,b){this._url=this._wmsUrl+"?REQUEST=GetLegendGraphic&FORMAT=image/png&WIDTH=20&HEIGHT=20"+"&LAYER="+a+"&SLD_BODY="+b.getEncodeURI()},this.getURL=function(){let a=this.baseURL;if(ams.Auth.isAuthenticated()){let b=document.location.protocol+'//'+document.location.hostname;a=b+ams.Config.general.oauthAPIProxyURI+this.baseURL}return a},this.init=function(a,b){this._setStaticLegends(),this._setWMSControl(a,b),this._map.addControl(this._wmsLegendControl)},this.disable=function(){this._map.removeControl(this._wmsLegendControl)},this.update=function(a,b){this._setStaticLegends(),this._setWMSControl(a,b),this._map.removeControl(this._wmsLegendControl),this._map.addControl(this._wmsLegendControl)},this._setWMSControl=function(a,b){this.setUrl(a,b),this._wmsLegendControl.options.uri=this._url,this._wmsLegendControl.options.position="middleright"},this._setStaticLegends=function(){let a=this.getURL()+"?REQUEST=GetLegendGraphic&FORMAT=image/png&WIDTH=20&HEIGHT=20";if(ams.App._referenceLayerName.includes(ams.Config.defaultLayers.deter)){let b=ams.App._appClassGroups.getCqlFilter(ams.App._suViewParams,ams.App._hasClassFilter),c=a+"&LAYER="+ams.App._referenceLayerName+"&LEGEND_OPTIONS=hideEmptyRules:true;forceLabels:on;"+"&CQL_FILTER="+b;this._wmsLegendControl.options.static.deter.url=c,this._wmsLegendControl.options.static.af.url=null,this._wmsLegendControl.options.static.risk.url=null}else if(ams.App._referenceLayerName.includes(ams.Config.defaultLayers.activeFire)){let b=a+"&LAYER="+ams.App._referenceLayerName+"&STYLE=active_fires_legend"+"&LEGEND_OPTIONS=forceLabels:on;";this._wmsLegendControl.options.static.af.url=b,this._wmsLegendControl.options.static.deter.url=null,this._wmsLegendControl.options.static.risk.url=null}else{let b=a+"&LAYER="+ams.App._referenceLayerName+"&STYLE=risk_legend"+"&LEGEND_OPTIONS=forceLabels:on;";this._wmsLegendControl.options.static.af.url=null,this._wmsLegendControl.options.static.deter.url=null,this._wmsLegendControl.options.static.risk.url=b}}}}