var ams=ams||{};ams.App={zoomThreshold:11,_layerControl:null,_baseLayers:[],_addedLayers:[],_biomeLayer:null,_appClassGroups:null,_suViewParams:null,_priorViewParams:null,_wfs:null,_dateControl:null,_baseURL:null,_propertyName:null,_referenceLayerName:null,_currentSULayerName:null,_hasClassFilter:!1,_diffOn:!1,_currentTemporalAggregate:null,_currentClassify:null,_spatialUnits:null,_landUseList:[],run:function(z,C,d){var n,e,b,j,m,p,q,u,y,h,s,o,t,c,a,k,g,x;this._spatialUnits=C,this._appClassGroups=d,this._landUseList=ams.Config.landUses.map(a=>a.id),this._wfs=new ams.Map.WFS(z),n=ams.Auth.getWorkspace()+":"+ams.Config.defaultLayers.lastDate,e=new ams.Map.TemporalUnits,this._dateControl=new ams.Date.DateController;let f=this._wfs.getLastDate(n);f=f||this._spatialUnits.getDefault().last_date,this._currentTemporalAggregate=e.getAggregates()[0].key,this._dateControl.setPeriod(f,this._currentTemporalAggregate),this._baseURL=z+"/wms",this._propertyName=ams.Config.defaultFilters.indicator=='AF'?ams.Config.propertyName.af:ams.Config.propertyName.deter,this._referenceLayerName=ams.Auth.getWorkspace()+":"+(ams.Config.defaultFilters.indicator=='AF'?ams.Config.defaultLayers.activeFire:ams.Config.defaultLayers.deter),this._hasClassFilter=ams.Config.defaultFilters.indicator=='AF'?!1:!0,this._currentClassify=ams.Config.defaultFilters.diffClassify,b=new L.Map("map",{zoomControl:!1,minZoom:4}),this._map=b,ams.LeafletControlPosition.addNewPositions(b),b.setView([this._spatialUnits.getDefault().center_lat,this._spatialUnits.getDefault().center_lng],5),this._baseLayers.osm=new L.TileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:18,minZoom:4}).addTo(b);let r={attribution:'&copy; <a href="https://www.google.com/maps/">Google Maps</a>',maxZoom:18,minZoom:4,subdomains:['mt0','mt1','mt2','mt3']},i=[{index:"gs",name:"Google Satellite",param:"s"},{index:"gh",name:"Google Hybrid",param:"s,h"},{index:"gst",name:"Google Streets",param:"m"},{index:"gte",name:"Google Terrain",param:"p"}];for(let a in i){let b="https://{s}.google.com/vt/lyrs="+i[a].param+"&x={x}&y={y}&z={z}";r.name=i[a].name,this._baseLayers[i[a].index]=new L.TileLayer(b,r)}this._baseLayers.blank=new L.TileLayer(""),L.control.scale({position:'bottomright'}).addTo(b),b.on('zoomend',function(d){let c=b.getZoom(),a=ams.App._getLayerByName(ams.App._referenceLayerName);if(!a)return;c>=ams.App.zoomThreshold?a.bringToFront():a.bringToBack()}),this._suViewParams=new ams.Map.ViewParams(ams.Config.defaultFilters.indicator,ams.App._dateControl,ams.App._propertyName,"ALL"),this._priorViewParams=new ams.Map.ViewParams(ams.Config.defaultFilters.indicator,ams.App._dateControl,ams.App._propertyName,ams.Config.defaultFilters.priorityLimit),j=ams.Auth.getWorkspace()+":"+ams.Config.defaultLayers.deter,m=ams.Auth.getWorkspace()+":"+ams.Config.defaultLayers.activeFire,p={cql_filter:d.getCqlFilter(this._suViewParams,!0),viewparams:"landuse:"+ams.App._landUseList.join('\\,')},ams.App._addWmsOptionsBase(p),q={cql_filter:d.getCqlFilter(this._suViewParams,!1),viewparams:"landuse:"+ams.App._landUseList.join('\\,')},ams.App._addWmsOptionsBase(q),u=new ams.LeafletWms.Source(this._baseURL,p,d),y=new ams.LeafletWms.Source(this._baseURL,q,d),h=u.getLayer(j);let l=y.getLayer(m);this._referenceLayerName==j?(h.addTo(b),h.bringToBack()):(l.addTo(b),l.bringToBack()),this._addedLayers[j]=h,this._addedLayers[m]=l,this._legendControl=new ams.Map.LegendController(b,this._baseURL),this._currentSULayerName=ams.Auth.getWorkspace()+":"+this._spatialUnits.getDefault().dataname,ams.Config.defaultFilters.spatialUnit=this._spatialUnits.getDefault().dataname,this._addSpatialUnitLayer(this._getLayerPrefix(),this._propertyName),s=ams.Config.defaultLayers.biomeBorder,o={identify:!1},ams.App._addWmsOptionsBase(o),t=new ams.LeafletWms.Source(this._baseURL,o,this._appClassGroups),ams.App._biomeLayer=t.getLayer(s),ams.App._biomeLayer.addTo(b).bringToBack(),c={BIOMA:{defaultFilter:ams.Config.biome},INDICADOR:{defaultFilter:ams.Config.defaultFilters.indicator,propertyName:this._propertyName},"CATEGORIA FUNDIÁRIA":{defaultFilter:''},"UNIDADE ESPACIAL":{defaultFilter:ams.Config.defaultFilters.spatialUnit},"UNIDADE TEMPORAL":{defaultFilter:ams.Config.defaultFilters.temporalUnit},"CLASSIFICAÇÃO DO MAPA":{defaultFilter:ams.Config.defaultFilters.diffClassify}};for(let a in ams.BiomeConfig)ams.BiomeConfig.hasOwnProperty(a)&&(c.BIOMA[a]=a);for(let a in ams.Config.landUses)ams.Config.landUses.hasOwnProperty(a)&&ams.Config.landUses[a]&&(c["CATEGORIA FUNDIÁRIA"].defaultFilter+=(c["CATEGORIA FUNDIÁRIA"].defaultFilter==''?'':',')+ams.Config.landUses[a].id,c["CATEGORIA FUNDIÁRIA"][ams.Config.landUses[a].name]=''+ams.Config.landUses[a].id);let B=this._spatialUnits.length();for(a=0;a<B;a++){let b=ams.Auth.getWorkspace()+":"+this._spatialUnits.at(a).dataname;c["UNIDADE ESPACIAL"][this._spatialUnits.at(a).description]=b}let A=d.length();for(a=0;a<A;a++)c.INDICADOR[d.at(a).name]=d.at(a).acronym;k=e.getAggregates();for(a=0;a<Object.keys(k).length;a++)c["UNIDADE TEMPORAL"][k[a].value]=k[a].key;g=e.getDifferences();for(a=0;a<Object.keys(g).length;a++)c["CLASSIFICAÇÃO DO MAPA"][g[a].value]=g[a].key;x=L.control.groupedLayers(c,{exclusiveGroups:["UNIDADE ESPACIAL","INDICADOR","UNIDADE TEMPORAL","CLASSIFICAÇÃO DO MAPA"],collapsed:!1,position:"topleft"}).addTo(b),ams.groupControl=x,L.control.coordinates({position:"bottomright",decimals:2,decimalSeperator:",",enableUserInput:!1,centerUserCoordinates:!0,useLatLngOrder:!1,labelTemplateLat:"Latitude: {y}",labelTemplateLng:"Longitude: {x}"}).addTo(b),ams.PeriodHandler.init(b),this._addControlLayer(),b.on('changectrl',function(a){if(ams.App._landUseList.length==0&&a.group.name!='CATEGORIA FUNDIÁRIA'&&a.group.name!='BIOMA'){ams.App._resetMap("O filtro deve incluir ao menos uma categoria fundiária. A solicitação não foi concluída.");return}let c,d,b=!0;if(a.group.name=='BIOMA'){if(a.acronym==ams.Config.biome)return;ams.App._landUseList.length!=ams.Config.landUses.length&&($('.toast').toast('show'),$('.toast-body').html("O filtro por categorias fundiárias foi restaurado ao padrão."),ams.App._landUseList=ams.Config.landUses.map(a=>a.id)),ams.App._suViewParams=null,ams.App._priorViewParams=null,ams.App._diffOn=ams.Config.defaultFilters.diffClassify=="onPeriod"?!1:!0,localStorage.setItem('ams.previous.biome.setting.selection',a.acronym),ams.Utils.biomeChanges(a.acronym)}else if(a.group.name=='INDICADOR'){if(a.acronym=='AF'?(c=ams.Auth.getWorkspace()+":"+ams.Config.defaultLayers.activeFire,d=ams.Auth.getWorkspace()+":"+ams.Config.defaultLayers.deter,ams.App._propertyName=ams.Config.propertyName.af,ams.App._hasClassFilter=!1):(c=ams.Auth.getWorkspace()+":"+ams.Config.defaultLayers.deter,d=ams.Auth.getWorkspace()+":"+ams.Config.defaultLayers.activeFire,ams.App._propertyName=ams.Config.propertyName.deter,ams.App._hasClassFilter=!0),ams.App._suViewParams.classname!=a.acronym){ams.App._suViewParams.classname=a.acronym,ams.App._priorViewParams.classname=a.acronym,ams.App._suViewParams.updatePropertyName(ams.App._propertyName),ams.App._priorViewParams.updatePropertyName(ams.App._propertyName);let b=ams.App._wfs.getLastDate(n);b=b||ams.App._spatialUnits.getDefault().last_date,ams.App._dateControl.setPeriod(b,ams.App._currentTemporalAggregate),ams.PeriodHandler.changeDate(ams.App._dateControl.startdate)}ams.App._referenceLayerName!=c?ams.App._exchangeReferenceLayer(d,c):ams.App._hasClassFilter&&ams.App._updateReferenceLayer()}else if(a.group.name=='CATEGORIA FUNDIÁRIA'){let c=+a.acronym;if(a.inputtype=='checkbox'){let b=ams.App._landUseList.findIndex(a=>a==c);a.checked&&b<0&&(ams.App._landUseList.push(c),ams.App._resetMap()),!a.checked&&b>=0&&(ams.App._landUseList.splice(b,1),ams.App._resetMap())}b=!1}else if(a.group.name=='UNIDADE ESPACIAL'){if(ams.App._currentSULayerName!=a.acronym){let c=ams.App._getLayerPrefix();ams.App._currentSULayerName=a.acronym;let d=ams.App._getLayerPrefix();ams.App._exchangeSpatialUnitLayer(c,d),b=!1}}else if(a.group.name=='CLASSIFICAÇÃO DO MAPA'){if(ams.App._diffOn=a.acronym=="onPeriod"?!1:!0,ams.App._currentClassify!=a.acronym){let c=ams.App._getLayerPrefix();ams.App._currentClassify=a.acronym;let d=ams.App._getLayerPrefix();ams.App._exchangeSpatialUnitLayer(c,d),b=!1}}else e.isAggregate(a.name)&&(ams.App._currentTemporalAggregate=a.acronym,ams.PeriodHandler.changeDate(ams.App._dateControl.startdate),b=!1);b&&ams.App._updateSpatialUnitLayer()}),b.whenReady(()=>{window.setTimeout(()=>{ams.App._onWindowResize()},500)});function v(){let a=document.getElementById("prioritization-input").value;ams.App._priorViewParams.limit=a,ams.App._updateSpatialUnitLayer(!0)}$("#prioritization-input").keypress(function(a){if(a.which==13)return v(),!1}),$("#prioritization-button").click(function(){return v(),!1});let w=function(){let a={};return a.className=ams.App._suViewParams.classname,a.spatialUnit=ams.Config.biome,a.startDate=ams.App._dateControl.startdate,a.tempUnit=ams.App._currentTemporalAggregate,a.suName=ams.Config.biome,a.landUse=ams.App._landUseList.join(','),ams.App.displayGraph(a),!1};$("#profile-"+ams.BiomeConfig["Amazônia"].defaultWorkspace+"-button").click(w),$("#profile-"+ams.BiomeConfig.Cerrado.defaultWorkspace+"-button").click(w);let D=function(){return ams.App._landUseList.length==0?ams.App._resetMap("O filtro deve incluir ao menos uma categoria fundiária. A solicitação não foi concluída."):(ams.App._updateSpatialUnitLayer(),ams.App._updateReferenceLayer()),!1};$("#landuse-categories-button").click(D);let E=function(){let a=$('#ckb-itens');if(a[0]){let b=a[0].getElementsByTagName('input');if(b.length){for(let a=0;a<b.length;a++){const c=b[a];c.checked=ams.App._landUseList.length?!1:!0}ams.App._landUseList=ams.App._landUseList.length?[]:ams.Config.landUses.map(a=>a.id)}}return ams.App._resetMap(),!1};$("#all-categories-button").click(E);let F=function(a){return a.target.innerText=='arrow_drop_down'?(a.target.innerText='arrow_drop_up',$("#landuse-itens")[0].style="display:flex;"):(a.target.innerText='arrow_drop_down',$("#landuse-itens")[0].style="display:none;"),!1};$(".iconlanduse-updown").click(F),$(function(){$("#prioritization-input").dblclick(!1)}),$("#shapezip-download-button").click(function(){return ams.App._wfs.getShapeZip(ams.App._getLayerPrefix(),ams.App._suViewParams),!1}),$("#csv-download-button").click(function(){return ams.App._wfs.getCsv(ams.App._getLayerPrefix(),ams.App._priorViewParams),!1}),$("#threshold").on("change",()=>{let a=+$("#threshold").val();ams.Config.general.area.threshold=a,localStorage.setItem('ams.config.general.area.threshold',a)}),$("#changeunit").on("change",()=>{let a=$("#changeunit")[0].checked;a?ams.Config.general.area.changeunit="auto":ams.Config.general.area.changeunit="no",localStorage.setItem('ams.config.general.area.changeunit',ams.Config.general.area.changeunit)}),$(function(){localStorage.getItem('ams.config.general.area.changeunit')!==null&&(ams.Config.general.area.changeunit=localStorage.getItem('ams.config.general.area.changeunit')),localStorage.getItem('ams.config.general.area.threshold')!==null&&(ams.Config.general.area.threshold=localStorage.getItem('ams.config.general.area.threshold')),$("#threshold").val(ams.Config.general.area.threshold),$("#changeunit")[0].checked=ams.Config.general.area.changeunit=="auto"})},_updateReferenceLayer:function(){let a=this._getLayerByName(this._referenceLayerName);if(a){let b=ams.App._appClassGroups.getCqlFilter(ams.App._suViewParams,this._hasClassFilter);a._source.options.cql_filter=b;let c={cql_filter:b,viewparams:"landuse:"+ams.App._landUseList.join('\\,')};this._addWmsOptionsBase(c),a._source._overlay.setParams(c),this._map.hasLayer(a)||a.addTo(this._map),a.bringToBack()}},_updateSpatialUnitLayer:function(c){this._map.closePopup(),c=typeof c=='undefined'?!1:c;let a=null,b=this._getMinMax(this._getLayerPrefix(),this._propertyName);if(!b)return;if(!c)if(a=this._getLayerByName(this._getLayerPrefix()),a&&this._map.hasLayer(a)){let d=new ams.SLDStyles.AreaStyle(this._getLayerPrefix(),this._propertyName,b.suLayerMin,b.suLayerMax),c={opacity:.8,viewparams:this._suViewParams.toWmsFormat(),sld_body:d.getSLD()};this._addWmsOptionsBase(c),a._source._overlay.setParams(c),Object.assign(a.options,c),Object.assign(a._source.options,c),a.bringToFront(),this._legendControl.update(this._getLayerPrefix(),d)}if(a=this._getLayerByName(this._getLayerPrefix()+'_prior'),a&&this._map.hasLayer(a)){let d=new ams.SLDStyles.AreaStyle(this._getLayerPrefix(),this._propertyName,b.suLayerMin,b.suLayerMax,!0,"#ff0000"),c={viewparams:this._priorViewParams.toWmsFormat(),sld_body:d.getSLD()};this._addWmsOptionsBase(c),a._source._overlay.setParams(c),Object.assign(a.options,c),Object.assign(a._source.options,c),a.bringToFront()}},_addWmsOptionsBase:function(b){let a={transparent:!0,tiled:!0,format:"image/png"};for(let c in a)b[c]=a[c]},_addControlLayer:function(){ams.App._layerControl&&ams.App._map.removeControl(ams.App._layerControl);let b={OpenStreetMap:ams.App._baseLayers.osm,"Google Satélite":ams.App._baseLayers.gs,"Google Híbrido":ams.App._baseLayers.gh,"Google Ruas":ams.App._baseLayers.gst,"Google Terreno":ams.App._baseLayers.gte,"Em branco":ams.App._baseLayers.blank},a={};for(let b in ams.App._addedLayers){let c=b.includes('deter')?"DETER":b.includes('fire')?"Focos":!1;ams.App._map.hasLayer(ams.App._addedLayers[b])&&c!==!1&&(a[c]=ams.App._addedLayers[b])}ams.App._biomeLayer&&(a[ams.Config.biome]=ams.App._biomeLayer),ams.App._layerControl=L.control.layers(b,a).addTo(ams.App._map)},_exchangeReferenceLayer:function(c,b){ams.App._removeLayer(c),this._referenceLayerName=b;let a=this._getLayerByName(b);if(a){let b=this._appClassGroups.getCqlFilter(this._suViewParams,this._hasClassFilter);a._source.options.cql_filter=b;let c={cql_filter:b,viewparams:"landuse:"+ams.App._landUseList.join('\\,')};this._addWmsOptionsBase(c),a._source._overlay.setParams(c),a.addTo(this._map),a.bringToBack()}this._addControlLayer()},_addSpatialUnitLayer:function(a,c){let e=this._getLayerByName(a),f=this._getLayerByName(a+'_prior');e&&delete this._addedLayers[a],f&&delete this._addedLayers[a+'_prior'];let d=this._getMinMax(a,c);if(!d)return;let b=this._createSULayer(a,c,d);b.addTo(this._map),b=this._createPriorSULayer(a,c,d),b.addTo(this._map),b.bringToFront()},_getWmsOptions:function(d,e,c,g,a){a=typeof a=='undefined'?!1:a;let f=a?new ams.SLDStyles.AreaStyle(d,e,c.suLayerMin,c.suLayerMax,!0,"#ff0000"):new ams.SLDStyles.AreaStyle(d,e,c.suLayerMin,c.suLayerMax);a||this._legendControl.init(d,f);let b={viewparams:g.toWmsFormat(),sld_body:f.getSLD()};return a?b.identify=!1:b.opacity=.8,this._addWmsOptionsBase(b),b},_createSULayer:function(a,b,c){let d=this._getWmsOptions(a,b,c,this._suViewParams),e=new ams.LeafletWms.Source(this._baseURL,d,this._appClassGroups);return layer=e.getLayer(a),this._addedLayers[a]=layer,layer},_createPriorSULayer:function(a,b,c){let d=this._getWmsOptions(a,b,c,this._priorViewParams,!0),e=new ams.LeafletWms.Source(this._baseURL,d,this._appClassGroups);return layer=e.getLayer(a),this._addedLayers[a+'_prior']=layer,layer},_getLayerByName:function(a){return typeof this._addedLayers[a]=='undefined'?!1:this._addedLayers[a]},_getLayerPrefix:function(){return this._currentSULayerName+(this._currentClassify=="onPeriod"?"_view":"_diff_view")},_getMinMax:function(b,c){let e=ams.App._diffOn?ams.App._wfs.getMin(b,c,ams.App._suViewParams):0,f=ams.App._wfs.getMax(b,c,ams.App._suViewParams),a={suLayerMin:e,suLayerMax:f};if(a.suLayerMax==a.suLayerMin){let a="";return ams.App._landUseList.length==0&&(a="<br /><br /><b>Atenção</b>: Deve selecionar ao menos um item no filtro por categorias fundiárias."),this._resetMap("Não existem dados para o período selecionado."+a),!1}if(ams.App._diffOn&&a.suLayerMin>=0)return this._resetMap("Não há redução de valores para o período selecionado."),!1;let d=ams.App._getLayerByName(ams.App._getLayerPrefix());return d&&!ams.App._map.hasLayer(d)&&ams.App._addSpatialUnitLayer(ams.App._getLayerPrefix(),ams.App._propertyName),a},_resetMap:function(a){typeof a!='undefined'&&($('.toast').toast('show'),$('.toast-body').html(a));let b=ams.App._getLayerPrefix();this._removeLayer(b),this._removeLayer(b+'_prior'),ams.App._legendControl.disable(),ams.App._removeLayer(ams.App._referenceLayerName)},_exchangeSpatialUnitLayer:function(a,b){this._removeLayer(a),this._removeLayer(a+'_prior'),ams.App._addSpatialUnitLayer(b,this._propertyName)},_removeLayer:function(b){let a=ams.App._getLayerByName(b);a&&this._map.hasLayer(a)&&this._removeSubLayer(a),this._map.closePopup()},_removeSubLayer:function(b){let a=[];for(a.push(b._leaflet_id),a.push(b._source._leaflet_id),a.push(b._source._overlay._leaflet_id);a.length;){let c=a.pop(),b=this._map._layers[c];b&&(typeof b.onRemove=='undefined'?delete this._map._layers[c]:this._map.hasLayer(b)&&this._map.removeLayer(b))}},_onWindowResize:function(){ams.groupControl._onWindowResize()},displayGraph:function(a){async function b(b){b.unit=ams.Map.PopupControl._unit,b.targetbiome=ams.Config.biome;let c=JSON.stringify(b),a=await fetch("callback/spatial_unit_profile?sData="+c).catch(()=>{console.log("The backend service may be offline or your internet connection has been interrupted.")});if($("#loading_data_info").css('display','none'),a&&a.ok){let b=await a.json();document.getElementById("txt3a").innerHTML=b.FormTitle,Plotly.react('AreaPerYearTableClass',JSON.parse(b.AreaPerYearTableClass),{}),Plotly.purge('AreaPerLandUse'),ams.App._landUseList.length>1&&Plotly.react('AreaPerLandUse',JSON.parse(b.AreaPerLandUse),{}),$('#modal-container-general-info').modal();let c=$('g.legend');c.attr('data-html','true'),c.attr('title','Descrição das categorias fundiárias.<br />-----------------------------------------------------------------------<br />TI: Terras Indígenas;<br />UC: Unidades de Conservação;<br />Assentamentos: Projetos de assentamentos de todos os tipos;<br />APA: Área de Proteção Ambiental;<br />CAR: Cadastro Ambiental Rural;<br />FPND: Florestas Públicas Não Destinadas;<br />Indefinida: Todas as demais áreas'),c.mouseover(function(){let a=$('g.legend');a.tooltip('show')})}else{let b="";a?b="HTTP-Error: "+a.status+" on spatial_unit_profile":b="O servidor está indisponível ou sua internet está desligada.",console.log(b),$('.toast').toast('show'),$('.toast-body').html("Encontrou um erro na solicitação ao servidor.<br />"+b)}}a.className!='null'&&(ams.App._landUseList.length>0?($("#loading_data_info").css('display','block'),b(a)):ams.App._resetMap("O filtro deve incluir ao menos uma categoria fundiária. A solicitação não foi concluída."))}}